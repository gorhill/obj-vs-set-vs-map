<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body style="font: 14px sans-serif">
<h1>Benchmark: Set-based vs RegExp-based dictionary of hostnames</h1>
<p><button id="runBenchmark">Run</button></p>
<div id="results-0" style="white-space:pre;font-family:mono"></div>
<div id="results-1" style="white-space:pre;font-family:mono"></div>
<div id="results-2" style="white-space:pre;font-family:mono"></div>
<div id="results-3" style="white-space:pre;font-family:mono"></div>
<div id="results-4" style="white-space:pre;font-family:mono"></div>
<div id="results-5" style="white-space:pre;font-family:mono"></div>
<div id="results-6" style="white-space:pre;font-family:mono"></div>

<script src="https://cdn.jsdelivr.net/lodash/4.17.2/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/platform.js/1.3.3/platform.js"></script>
<script src="https://cdn.jsdelivr.net/benchmarkjs/2.1.2/benchmark.js"></script>
<script>
var domainLowCount = 'gamenguide.com|itechpost.com|parentherald.com',
    domainMediumCount = 'anime-joy.tv|boards2go.com|celebdirtylaundry.com|celebritymozo.com|collectivelyconscious.net|dailycaller.com|destructoid.com|dumpaday.com|extratorrent.cc|fastpic.ru|firstrowau.eu|firstrowus1.eu|flash-x.tv|flashsx.tv|flashx.me|flashx.run|flashx.tv|flashx1.tv|flashxx.tv|fmovies.to|free-torrent.org|free-torrent.pw|free-torrents.org|free-torrents.pw|gamenguide.com|gofirstrow.eu|gorillavid.in|gsmarena.com|health-weekly.net|i4u.com|ifirstrow.eu|ifirstrowit.eu|imagefap.com|instanonymous.com|itechpost.com|izismile.com|jpost.com|lifehacklane.com|livescience.com|mobilenapps.com|mobipicker.com|natureworldnews.com|navbug.com|ncscooper.com|newsarama.com|newseveryday.com|nowfeed2all.eu|nowvideo.sx|okceleb.com|omgwhut.com|openload.co|opensubtitles.org|parentherald.com|pornhub.com|postimg.org|putlocker9.com|pwinsider.com|qaafa.com|shorte.st|snoopfeed.com|sportsmole.co.uk|stream-tv-series.net|stream-tv2.to|stream2watch.cc|streamgaroo.com|technobuffalo.com|the-watch-series.to|thevideo.me|thinkinghumanity.com|todayshealth.buzz|tomsguide.com|tomshardware.co.uk|tomshardware.com|tomsitpro.com|toptenz.net|tribune.com.pk|tune.pk|uberhavoc.com|universityherald.com|vcpost.com|vidmax.com|vidtodo.com|vidzi.tv|viewmixed.com|viid.me|viralands.com|webfirstrow.eu|whydontyoutrythis.com|wrestlinginc.com|wrestlingnews.co|xilfy.com|yourtango.com',
    domainHighCount = '101cargames.com|1025thebull.com|1031iheartaustin.com|1037theq.com|1041beat.com|1053kissfm.com|1057ezrock.com|1067litefm.com|10news.com|1310news.com|247comedy.com|3news.co.nz|49ers.com|610cktb.com|680news.com|700wlw.com|850koa.com|923jackfm.com|92q.com|940winz.com|94hjy.com|99kisscountry.com|abc15.com|abc2news.com|abcactionnews.com|am1300thezone.com|ap.org|atlantafalcons.com|automobilemag.com|automotive.com|azcardinals.com|baltimoreravens.com|baynews9.com|bbc.co.uk|bbc.com|belfasttelegraph.co.uk|bengals.com|bet.com|big1059.com|bigdog1009.ca|bloomberg.com|bnn.ca|boom92houston.com|boom945.com|boom973.com|boom997.com|boomphilly.com|box10.com|brisbanetimes.com.au|buccaneers.com|buffalobills.com|bullz-eye.com|calgaryherald.com|caller.com|canada.com|capitalfm.ca|cbslocal.com|cbsnews.com|cbssports.com|channel955.com|chargers.com|chez106.com|chfi.com|chicagobears.com|chicagotribune.com|cj104.com|cjad.com|cjbk.com|clevelandbrowns.com|cnet.com|coast933.com|colts.com|commercialappeal.com|country1011.com|country1043.com|country1067.com|country600.com|courierpress.com|cp24.com|cricketcountry.com|csmonitor.com|ctvnews.ca|dallascowboys.com|denverbroncos.com|detroitlions.com|drive.com.au|earthcam.com|easyrecipesite.com|edmontonjournal.com|egirlgames.net|elvisduran.com|enjoydressup.com|entrepreneur.com|eonline.com|escapegames.com|euronews.com|eurosport.com|eveningecho.ie|fm98wjlb.com|foodnetwork.ca|four.co.nz|foxradio.ca|foxsportsradio.com|gamingbolt.com|ghananation.com|giantbomb.com|giants.com|globalnews.ca|globaltoronto.com|globaltv.com|globaltvbc.com|globaltvcalgary.com|go.com|gorillanation.com|gosanangelo.com|hallelujah1051.com|hellobeautiful.com|heraldsun.com.au|hgtv.ca|hiphopnc.com|hot1041stl.com|hotair.com|hothiphopdetroit.com|hotspotatl.com|houstontexans.com|ibtimes.co.uk|ign.com|iheart.com|independent.ie|independentmail.com|indyhiphop.com|ipowerrichmond.com|jackfm.ca|jaguars.com|jwplatform.com|kase101.com|kcchiefs.com|kcci.com|kcra.com|kdvr.com|kfiam640.com|kgbx.com|khow.com|kiisfm.com|kiss925.com|kissnorthbay.com|kisssoo.com|kisstimmins.com|kitsapsun.com|kitv.com|kjrh.com|knoxnews.com|kogo.com|komonews.com|kshb.com|kwgn.com|kxan.com|kysdc.com|latimes.com|latinchat.com|leaderpost.com|livestream.com|local8now.com|magic96.com|majorleaguegaming.com|metacafe.com|miamidolphins.com|mix923fm.com|moneycontrol.com|montrealgazette.com|motorcyclistonline.com|moviemistakes.com|mtv.ca|myboom1029.com|mycolumbuspower.com|myezrock.com|naplesnews.com|nationalpost.com|nba.com|ndtv.com|neworleanssaints.com|news1130.com|newsinc.com|newsmax.com|newsmaxhealth.com|newsnet5.com|newsone.com|newstalk1010.com|newstalk1130.com|newyorkjets.com|nydailynews.com|nymag.com|oldschoolcincy.com|ottawacitizen.com|packers.com|panthers.com|patriots.com|pcworld.com|philadelphiaeagles.com|play.it|player.screenwavemedia.com|prowrestling.com|q92timmins.com|raaga.com|radio.com|radionowindy.com|raiders.com|rapbasement.com|redding.com|redskins.com|reporternews.com|reuters.com|rollingstone.com|rootsports.com|rottentomatoes.com|seahawks.com|sherdog.com|skynews.com.au|slice.ca|smh.com.au|sploder.com|sportsnet590.ca|sportsnet960.ca|springboardplatform.com|steelers.com|stlouisrams.com|streetfire.net|stuff.co.nz|tcpalm.com|telegraph.co.uk|theage.com.au|theaustralian.com.au|thebeatdfw.com|theboxhouston.com|thedenverchannel.com|thedrocks.com|theindychannel.com|theprovince.com|thestarphoenix.com|tide.com|timescolonist.com|timeslive.co.za|timesrecordnews.com|titansonline.com|totaljerkface.com|townhall.com|tripadvisor.ca|tripadvisor.co.uk|tripadvisor.co.za|tripadvisor.com|tripadvisor.com.au|tripadvisor.com.my|tripadvisor.com.sg|tripadvisor.ie|tripadvisor.in|turnto23.com|tvone.tv|twitch.tv|twitchy.com|usmagazine.com|vancouversun.com|vcstar.com|veetle.com|vice.com|videojug.com|viki.com|vikings.com|virginradio.ca|vzaar.com|wapt.com|washingtonpost.com|washingtontimes.com|wcpo.com|wdfn.com|weather.com|wescfm.com|wgci.com|wibw.com|wikihow.com|windsorstar.com|wiod.com|wiznation.com|wjdx.com|wkyt.com|wor710.com|wptv.com|wsj.com|wxyz.com|wyff4.com|yahoo.com|youtube.com|z100.com|zhiphopcleveland.com';

var needles = ['example.com', 'www.example.com', 'subdomain2.subdomain1.example.org', 'www.khow.com' ];

var randomArrayIndex = function(aa) {
    return Math.floor((Math.random() * 65536) % aa.length);
};

var createRandomNeedleSet = function() {
    return [
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
    ];
};

var setBasedDictCreate = function(domainOpt) {
    // Only one hostname
    if ( domainOpt.indexOf('|') === -1 ) {
        if ( domainOpt.startsWith('~') ) {
            return domainOpt.slice(1);
        }
        return domainOpt;
    }

    // Multiple hostnames: use a dictionary.
    var hostnames = domainOpt.split('|');
    var i, hostname, dict;

    // First find out whether we have a homogeneous dictionary
    var hit = false, miss = false;
    i = hostnames.length;
    while ( i-- ) {
        if ( hostnames[i].startsWith('~') ) {
            miss = true;
            if ( hit ) {
                break;
            }
        } else {
            hit = true;
            if ( miss ) {
                break;
            }
        }
    }

    // Heterogenous dictionary: this can happen, though VERY rarely.
    // Spotted one occurrence in EasyList Lite (cjxlist.txt):
    //   domain=photobucket.com|~secure.photobucket.com
    if ( hit && miss ) {
        dict = new Map();
        i = hostnames.length;
        while ( i-- ) {
            hostname = hostnames[i];
            if ( hostname.startsWith('~') ) {
                dict.set(hostname.slice(1), false);
            } else {
                dict.set(hostname, true);
            }
        }
        return dict;
    }

    // Homogeneous dictionary.
    dict = new Set();
    i = hostnames.length;
    while ( i-- ) {
        hostname = hostnames[i];
        dict.add(hostname.startsWith('~') ? hostname.slice(1) : hostname);
    }

    return dict;
};

var setBasedDictTest = function(haystack, needle) {
    var pos;
    for (;;) {
        if ( haystack.has(needle) ) { return true; }
        pos = needle.indexOf('.');
        if ( pos === -1 ) { break; }
        needle = needle.slice(pos + 1);
    }
    return false;
};

var regexBasedDictCreate = function(domainOpt) {
    // Only one hostname
    if ( domainOpt.indexOf('|') === -1 ) {
        if ( domainOpt.startsWith('~') ) {
            return domainOpt.slice(1);
        }
        return domainOpt;
    }

    // Many hostnames.

    // Must be in dictionary (none negated).
    if ( domainOpt.indexOf('~') === -1 ) {  // all non-negated
        return new RegExp('(?:^|\\.)(?:' + domainOpt.replace(/\./g, '\\.') + ')$');
    }

    // Must not be in dictionary (all negated).
    if ( reDomainOptAllNegated.test(domainOpt) ) {
        return new RegExp('(?:^|\\.)(?:' + domainOpt.replace(/~/g, '').replace(/\./g, '\\.') + ')$');
    }

    // Heterogenous dictionary: this can happen, though VERY rarely.
    // Spotted one occurrence in EasyList Lite (cjxlist.txt):
    //   domain=photobucket.com|~secure.photobucket.com
    var hostnames = domainOpt.split('|'),
        i = hostnames.length,
        dict = new Map(),
        hostname;
    while ( i-- ) {
        hostname = hostnames[i];
        if ( hostname.startsWith('~') ) {
            dict.set(hostname.slice(1), false);
        } else {
            dict.set(hostname, true);
        }
    }
    return dict;
};
var reDomainOptAllNegated = /^~(?:[^\|~]+\|~)+[^\|~]+$/;

var regexBasedDictTest = function(haystack, needle) {
    return haystack.test(needle);
};

var gResults = new Array(8);
var gWhich;
var gBenchmarks = [ null ];

var gSetBasedSmallDict = setBasedDictCreate(domainLowCount),
    gRegexBasedSmallDict = regexBasedDictCreate(domainLowCount),
    gSetBasedLargeDict = setBasedDictCreate(domainHighCount),
    gRegexBasedLargeDict = regexBasedDictCreate(domainHighCount);

function stdout(which, text) {
    var r = document.querySelector('#results-' + which);
    if ( text === '' ) {
        r.innerHTML = '';
    } else {
        r.innerHTML += text;
    }
}

function doBenchmark() {
    stdout(0, '');
    stdout(0, 'Benchmarking, the higher ops/sec the better.\n');
    stdout(0, Benchmark.platform.toString() + '.');
    stdout(0, '\n\n');
    gWhich = 1;
    gBenchmarks[gWhich].run({ 'async': true });
}

function nextBenchmark() {
    stdout(gWhich, 'Done.\n\n');
    gWhich += 1;
    var bms = gBenchmarks[gWhich];
    if ( bms ) {
        bms.run({ 'async': true });
    }
}

gBenchmarks.push((function() {
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            gResults[randomArrayIndex(gResults)] = setBasedDictCreate(domainLowCount);
            })
        .add('  - Regex-based', function() {
            gResults[randomArrayIndex(gResults)] = regexBasedDictCreate(domainLowCount);
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Create small-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            gResults[randomArrayIndex(gResults)] = setBasedDictCreate(domainMediumCount);
            })
        .add('  - Regex-based', function() {
            gResults[randomArrayIndex(gResults)] = regexBasedDictCreate(domainMediumCount);
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Create medium-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            gResults[randomArrayIndex(gResults)] = setBasedDictCreate(domainHighCount);
            })
        .add('  - Regex-based', function() {
            gResults[randomArrayIndex(gResults)] = regexBasedDictCreate(domainHighCount);
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Create large-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var setHaystack = setBasedDictCreate(domainLowCount),
        regexHaystack = regexBasedDictCreate(domainLowCount),
        needles = createRandomNeedleSet();
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = setBasedDictTest(setHaystack, needles[i]);
            }
            })
        .add('  - Regex-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = regexBasedDictTest(regexHaystack, needles[i]);
            }
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Test against small-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var setHaystack = setBasedDictCreate(domainMediumCount),
        regexHaystack = regexBasedDictCreate(domainMediumCount),
        needles = createRandomNeedleSet();
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = setBasedDictTest(setHaystack, needles[i]);
            }
            })
        .add('  - Regex-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = regexBasedDictTest(regexHaystack, needles[i]);
            }
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Test against medium-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var setHaystack = setBasedDictCreate(domainHighCount),
        regexHaystack = regexBasedDictCreate(domainHighCount),
        needles = createRandomNeedleSet();
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = setBasedDictTest(setHaystack, needles[i]);
            }
            })
        .add('  - Regex-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = regexBasedDictTest(regexHaystack, needles[i]);
            }
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Test against large-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

window.onload = function() {
    document.getElementById('runBenchmark').onclick = function() {
        doBenchmark();
    };
};
</script>
</body>
</html>
