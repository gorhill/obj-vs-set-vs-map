<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body style="font: 14px sans-serif">
<h1>Benchmark: Set-based vs RegExp-based dictionary of hostnames</h1>
<p><button id="runBenchmark">Run</button></p>
<div id="results-0" style="white-space:pre;font-family:mono"></div>
<div id="results-1" style="white-space:pre;font-family:mono"></div>
<div id="results-2" style="white-space:pre;font-family:mono"></div>
<div id="results-3" style="white-space:pre;font-family:mono"></div>
<div id="results-4" style="white-space:pre;font-family:mono"></div>
<div id="results-5" style="white-space:pre;font-family:mono"></div>
<div id="results-6" style="white-space:pre;font-family:mono"></div>

<script src="https://cdn.jsdelivr.net/lodash/4.17.2/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/platform.js/1.3.3/platform.js"></script>
<script src="https://cdn.jsdelivr.net/benchmarkjs/2.1.2/benchmark.js"></script>
<script>
var domainLowCount = 'gamenguide.com|itechpost.com|parentherald.com',
    domainMediumCount = 'anime-joy.tv|boards2go.com|celebdirtylaundry.com|celebritymozo.com|collectivelyconscious.net|dailycaller.com|destructoid.com|dumpaday.com|extratorrent.cc|fastpic.ru|firstrowau.eu|firstrowus1.eu|flash-x.tv|flashsx.tv|flashx.me|flashx.run|flashx.tv|flashx1.tv|flashxx.tv|fmovies.to|free-torrent.org|free-torrent.pw|free-torrents.org|free-torrents.pw|gamenguide.com|gofirstrow.eu|gorillavid.in|gsmarena.com|health-weekly.net|i4u.com|ifirstrow.eu|ifirstrowit.eu|imagefap.com|instanonymous.com|itechpost.com|izismile.com|jpost.com|lifehacklane.com|livescience.com|mobilenapps.com|mobipicker.com|natureworldnews.com|navbug.com|ncscooper.com|newsarama.com|newseveryday.com|nowfeed2all.eu|nowvideo.sx|okceleb.com|omgwhut.com|openload.co|opensubtitles.org|parentherald.com|pornhub.com|postimg.org|putlocker9.com|pwinsider.com|qaafa.com|shorte.st|snoopfeed.com|sportsmole.co.uk|stream-tv-series.net|stream-tv2.to|stream2watch.cc|streamgaroo.com|technobuffalo.com|the-watch-series.to|thevideo.me|thinkinghumanity.com|todayshealth.buzz|tomsguide.com|tomshardware.co.uk|tomshardware.com|tomsitpro.com|toptenz.net|tribune.com.pk|tune.pk|uberhavoc.com|universityherald.com|vcpost.com|vidmax.com|vidtodo.com|vidzi.tv|viewmixed.com|viid.me|viralands.com|webfirstrow.eu|whydontyoutrythis.com|wrestlinginc.com|wrestlingnews.co|xilfy.com|yourtango.com',
    domainHighCount = '176.114.0.126|176.114.0.132|193.106.30.70|193.106.30.84|24video.sex|24video.xxx|24videos.in|2baksa.net|37.220.36.15|3dn.ru|4ertik.xxx|adultmult.tv|ahs-online.net|alexlan.org|all-episodes.net|all-tor.net|all-tv.org|allbesta.net|allday2.com|allhit.club|allhit.tv|allmovie.pro|amovies.biz|anekdot.ru|anidub-online.ru|anilibria.tv|anime-rus.ru|animespirit.ru|anistar.me|anti-block.org|apostrophe.ua|asbook.net|au-books.com|audilka.com|audioboo.ru|autonews.com.ua|badcinema.ru|badtorrent.com|bagnet.org|baskino-hd.ru|baskino.club|best-torrentor.ru|bestgamer.net|bestserials.net|bigbang-tv.net|bigcinema.to|bigtorrent.org|bit-tor.org|blogspot.com|blogspot.ru|bludlivaya-california.com|bobfilm-online.ru|bobfilm.club|book-online.com.ua|cccp-kino.com|cinema-hd.tv|coldfilm.ru|com-x.life|comedy-portal.net|consol-games.net|coop-land.ru|couber.be|cvid.kiev.ua|cwer.ws|dead-online.net|delfilm.ru|dnevniki-vampira.net|dnevniki-vampira.org|dochronika.ru|dom-filmov.ru|dom23.tv|dom25.tv|dom2tv.info|doramatv.ru|dostfilms.net|dream-film.tv|dt.ua|egeurok.ru|elementarno-tv.com|elise.com.ua|ero-top.com|euro-football.ru|f-picture.net|fanserials.com|fast-bit.org|fast-tor.net|fast-torrent.org|fast-torrent.ru|fastpic.ru|fastpicc.ru|fasttorrent.ru|favoritemovies.at.ua|filin.tv|film-max.ru|film-tor.org|filmix-online.net|filmix.net|filmogo.co|filmtor.net|filmzguru.ru|findanime.ru|firebit.net|fithacker.ru|fizrukoff.net|football.kulichki.net|football.ua|free-tor.org|free-torrent.org|free-torrent.pw|free-torrents.org|free-torrents.pw|freedom-tor.org|freehd.com.ua|freerutor.com|friends-online.co|fstreker.net|game-torrent.info|games-reviews.net|gamesontorrent.ru|gazeta.dt.ua|gdzometr.ru|get-tune.cc|gidonline.club|gidonlinehd.ru|gig-torrent.org|gighub.net|gooool.org|grimm-online.org|hd-720.com|hd-720.ucoz.net|hd-720.ucoz.ru|hd-dream.ru|hd-kinomax.net|hd-kinomax.org|hd720.biz|hdclub.org|hdgo.cc|hdkinoclub.com|hdkinohit.net|hdkinoklub.com|hdkinomax.com|hdkinoshka.net|hdkinoteatr.com|hdpicture.ru|hdreactor.org|hdrezka.biz|hdrezka.me|hdzal.net|hentaiz.org|hindcine.net|hotcharts.ru|hronika.info|igra-prestoloff.cx|ikinohd.com|imtw.ru|informat.com.ua|inopressa.ru|itop-gear.ru|katushka.net|kesemvv.com|kino-az.net|kino-dom.org|kino-filmi.net|kino-go.co|kino-hd.in|kino-hd720.net|kino-kingdom.com|kino-klub.net|kino-live.red|kino-live2.org|kino-max.com|kino-nada.net|kino-nada.ru|kino-sayt.net|kino-torrent.net|kino-v-online.tv|kinobal.ru|kinobar.kz|kinobublik.net|kinoclips.net|kinoclips.tv|kinocok.com|kinodacha.ucoz.ru|kinofrukt.net|kinogb.me|kinogo-1080.net|kinogo-2016.net|kinogo-720p.ru|kinogo-co-2016.ru|kinogo-hd.co|kinogo-hd.net|kinogo-net-2016.ru|kinogo-net-co.ru|kinogo-net.me|kinogo-onlain.net|kinogo-onlaine.net|kinogo-online.net|kinogo-ru.net|kinogo-x.ru|kinogo.by|kinogo.club|kinogo.eu|kinogo2.net|kinogo720.net|kinogo720hd.ru|kinogo720p.net|kinogohd.net|kinograd.tv|kinoha.top|kinohd-online.com|kinohome.org|kinohost.nov.ru|kinokong.cc|kinokrad-online.net|kinokrad.co|kinokrad.su|kinoliza.net|kinomagnit.net|kinomassa.net|kinomol.ru|kinomoov.net|kinoogo.ru|kinopati.ru|kinoprofi.org|kinoprofi.su|kinoprosmotr.net|kinoprosmotr.tv|kinostok.tv|kinosvit.tv|kinotochka.net|kinovo.org|kinozadrot.club|kinozadrot.org|kinozal.me|kinozal.tv|kinozal.website|kinozz.net|kkkino.net|klipzona.co|knijky.ru|kodik.cc|kodik.name|komedra.com|kordonivkakino.tv|korrespondent.net|korzik.net|kosti-tv.com|krutor.org|libtor.club|linecinema.org|live-torrents.ru|livetv-torrent.com|lostfilm-online.ru|lostfilmhd.ru|lostfilmonline.ru|loveread.ec|main-rutor.org|mega-tor.org|mega-torrent.org|mega-trek.com|mega-trek.net|megahead.ru|megaserial.net|megashara.com|megogo-hd.net|minizal.su|mirmegashara.com|moiserialy.net|moonwalk.cc|mp3.cc|mp3poisk.me|mp3zv.ru|mrutor.org|multiki-online24.ru|multivarka.tv|multon-line.ru|muz-color.ru|muztorr.ru|muzyka-torrent.ru|my-hit.org|my-music-kiosk.ru|my-tfile.org|myflashgame.com.ua|mymult.net|myserialy.ru|myvideopl.com|n-torrents.ru|naruto-base.su|narutoplanet.ru|nevsedoma.com.ua|new-rutor.org|new-tor.org|newserials.tv|newsmsk.com|newsyou.info|nice-film.ru|nnm-club.me|nnm-club.to|nnm.me|nnmclub.to|nod32eset.ru|notfilm.ru|novosti-n.org|nowa.cc|nur.kz|ojin.tv|ok-tv.org|on-movie.net|onelike.tv|onlainfilm.ucoz.ua|online-freebee.net|online-life.cc|online.anidub.com|onlinemultfilmy.ru|only-tv.org|onlymult.com|ostfilm.org|ostfilm.tv|ostfilmtv.org|pc-torrents.net|pdalife.ru|pesni-tut.com|pesnik.su|petamusic.ru|pixelbrush.ru|planeta-mult.ru|pleer.ws|podrobnosti.ua|poiskm.org|politeka.net|porjati.ru|prnt.sc|proxy-rutor.org|pure-t.ru|putin-today.ru|qmp3.org|radikal.ru|real-game.net|royallib.com|rsload.net|ru-tor.net|rubook.org|rudifilm.com|rufilmtv.org|rumedia.ws|rus-tor.com|rusdozor.ru|russiapost.su|rustorka.com|rutor.co|rutor.info|rutor.is|rutor.net|rutor.org|seasonvar.cc|seasonvar.re|seasonvar.ru|segodnya.ua|seria-z.net|serial.wiki|serialguru.ru|serialis.net|serialpro.net|serialsend.ru|serialytut.tv|sezon-hd.ru|share-serials.net|sherlok.me|show-online.tv|skidows.com|small-game.com|smotret-online.kz|smotri-filmi.net|sobytiya.net|sputniktv.in.ua|srubirubli.ru|stereotraker.ru|strana.ua|strela-online.com|super-tor.net|sverhestestvenoe.com|tapochek.net|teenwolf-tv.com|tes-game.ru|tfile-music.org|tfile.co|tfilm.club|the-cinema.ru|theflash-tv.com|tivix.co|tizam.tv|tor-bit.net|torentor.net|torrent-filmi.net|torrent-games.net|torrent-soft.net|torrent-windows.net|torrent-zone.ru|torrentino.me|torrentk.ru|torrentom.com|torrents-free.ru|torrents-game.net|torrentum.ru|totori.ru|tparser.org|tracker.hdclub.com.ua|trackeroc.ru|tracktor.tv|trialeset.ru|trymobile.ru|turboserial.net|turkcinema.tv|tushkan.club|tushkan.net|tushkan.tv|tut-film.com|tv-torrent.org|tvbook.tv|tvfru.net|tvizor.org|tvseason.net|tvserial-online.biz|tvtorrent.me|ua-cinema.com|uainfo.org|uchebnik-online.net|uchim.org|uniongang.net|unionpeer.org|univeroff.net|uraltrack.net|v-torrente.ru|vepizode.net|vgorode.ua|vikingi-online.net|viks.tv|vip-tor.org|vklipe.com|vsesochineniya.ru|vsetop.com|vsetv.net|vsitv.org|wikianime.ru|wkino.net|women-page.ru|world-ua.com|wow-show.ru|wsturbo.net|x-true.info|xhamster.com|ximepa.net|xn----etbhjjtcfb7b.net|xn----otba0aibt0b.su|xn--c1adkjnf.net|xn--c1ajfnfb.net|xrutor.org|xrutor.ru|yallaneliera.com|yaminecraft.ru|yourcinema.tv|youtubetv.com.ua|ytra.ru|yummyanime.com|zagonka.ru|zakon.kz|zerkalo-rutor.org|zerx.co|zfilm-hd.net|zn.ua|znaj.ua|zserials.tv|киного-нет.net|киного.net|легион.net|спиши-ру.su';

var needles = ['example.com', 'www.example.com', 'subdomain2.subdomain1.example.org', 'www.khow.com' ];

var randomArrayIndex = function(aa) {
    return Math.floor((Math.random() * 65536) % aa.length);
};

var createRandomNeedleSet = function() {
    return [
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
        needles[randomArrayIndex(needles)],
    ];
};

var setBasedDictCreate = function(domainOpt) {
    // Only one hostname
    if ( domainOpt.indexOf('|') === -1 ) {
        if ( domainOpt.startsWith('~') ) {
            return domainOpt.slice(1);
        }
        return domainOpt;
    }

    // Multiple hostnames: use a dictionary.
    var hostnames = domainOpt.split('|');
    var i, hostname, dict;

    // First find out whether we have a homogeneous dictionary
    var hit = false, miss = false;
    i = hostnames.length;
    while ( i-- ) {
        if ( hostnames[i].startsWith('~') ) {
            miss = true;
            if ( hit ) {
                break;
            }
        } else {
            hit = true;
            if ( miss ) {
                break;
            }
        }
    }

    // Heterogenous dictionary: this can happen, though VERY rarely.
    // Spotted one occurrence in EasyList Lite (cjxlist.txt):
    //   domain=photobucket.com|~secure.photobucket.com
    if ( hit && miss ) {
        dict = new Map();
        i = hostnames.length;
        while ( i-- ) {
            hostname = hostnames[i];
            if ( hostname.startsWith('~') ) {
                dict.set(hostname.slice(1), false);
            } else {
                dict.set(hostname, true);
            }
        }
        return dict;
    }

    // Homogeneous dictionary.
    dict = new Set();
    i = hostnames.length;
    while ( i-- ) {
        hostname = hostnames[i];
        dict.add(hostname.startsWith('~') ? hostname.slice(1) : hostname);
    }

    return dict;
};

var setBasedDictTest = function(haystack, needle) {
    var pos;
    for (;;) {
        if ( haystack.has(needle) ) { return true; }
        pos = needle.indexOf('.');
        if ( pos === -1 ) { break; }
        needle = needle.slice(pos + 1);
    }
    return false;
};

var regexBasedDictCreate = function(domainOpt) {
    // Only one hostname
    if ( domainOpt.indexOf('|') === -1 ) {
        if ( domainOpt.startsWith('~') ) {
            return domainOpt.slice(1);
        }
        return domainOpt;
    }

    // Many hostnames.

    // Must be in dictionary (none negated).
    if ( domainOpt.indexOf('~') === -1 ) {  // all non-negated
        return new RegExp('(?:^|\\.)(?:' + domainOpt.replace(/\./g, '\\.') + ')$');
    }

    // Must not be in dictionary (all negated).
    if ( reDomainOptAllNegated.test(domainOpt) ) {
        return new RegExp('(?:^|\\.)(?:' + domainOpt.replace(/~/g, '').replace(/\./g, '\\.') + ')$');
    }

    // Heterogenous dictionary: this can happen, though VERY rarely.
    // Spotted one occurrence in EasyList Lite (cjxlist.txt):
    //   domain=photobucket.com|~secure.photobucket.com
    var hostnames = domainOpt.split('|'),
        i = hostnames.length,
        dict = new Map(),
        hostname;
    while ( i-- ) {
        hostname = hostnames[i];
        if ( hostname.startsWith('~') ) {
            dict.set(hostname.slice(1), false);
        } else {
            dict.set(hostname, true);
        }
    }
    return dict;
};
var reDomainOptAllNegated = /^~(?:[^\|~]+\|~)+[^\|~]+$/;

var regexBasedDictTest = function(haystack, needle) {
    return haystack.test(needle);
};

var gResults = new Array(8);
var gWhich;
var gBenchmarks = [ null ];

var gSetBasedSmallDict = setBasedDictCreate(domainLowCount),
    gRegexBasedSmallDict = regexBasedDictCreate(domainLowCount),
    gSetBasedLargeDict = setBasedDictCreate(domainHighCount),
    gRegexBasedLargeDict = regexBasedDictCreate(domainHighCount);

function stdout(which, text) {
    var r = document.querySelector('#results-' + which);
    if ( text === '' ) {
        r.innerHTML = '';
    } else {
        r.innerHTML += text;
    }
}

function doBenchmark() {
    stdout(0, '');
    stdout(0, 'Benchmarking, the higher ops/sec the better.\n');
    stdout(0, Benchmark.platform.toString() + '.');
    stdout(0, '\n\n');
    gWhich = 1;
    gBenchmarks[gWhich].run({ 'async': true });
}

function nextBenchmark() {
    stdout(gWhich, 'Done.\n\n');
    gWhich += 1;
    var bms = gBenchmarks[gWhich];
    if ( bms ) {
        bms.run({ 'async': true });
    }
}

gBenchmarks.push((function() {
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            gResults[randomArrayIndex(gResults)] = setBasedDictCreate(domainLowCount);
            })
        .add('  - Regex-based', function() {
            gResults[randomArrayIndex(gResults)] = regexBasedDictCreate(domainLowCount);
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Create small-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            gResults[randomArrayIndex(gResults)] = setBasedDictCreate(domainMediumCount);
            })
        .add('  - Regex-based', function() {
            gResults[randomArrayIndex(gResults)] = regexBasedDictCreate(domainMediumCount);
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Create medium-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            gResults[randomArrayIndex(gResults)] = setBasedDictCreate(domainHighCount);
            })
        .add('  - Regex-based', function() {
            gResults[randomArrayIndex(gResults)] = regexBasedDictCreate(domainHighCount);
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Create large-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var setHaystack = setBasedDictCreate(domainLowCount),
        regexHaystack = regexBasedDictCreate(domainLowCount),
        needles = createRandomNeedleSet();
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = setBasedDictTest(setHaystack, needles[i]);
            }
            })
        .add('  - Regex-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = regexBasedDictTest(regexHaystack, needles[i]);
            }
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Test against small-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var setHaystack = setBasedDictCreate(domainMediumCount),
        regexHaystack = regexBasedDictCreate(domainMediumCount),
        needles = createRandomNeedleSet();
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = setBasedDictTest(setHaystack, needles[i]);
            }
            })
        .add('  - Regex-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = regexBasedDictTest(regexHaystack, needles[i]);
            }
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Test against medium-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

gBenchmarks.push((function() {
    var setHaystack = setBasedDictCreate(domainHighCount),
        regexHaystack = regexBasedDictCreate(domainHighCount),
        needles = createRandomNeedleSet();
    var bms = new Benchmark.Suite();
    bms
        .add('  -   Set-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = setBasedDictTest(setHaystack, needles[i]);
            }
            })
        .add('  - Regex-based', function() {
            for ( var i = 0, n = needles.length; i < n; i++ ) {
                gResults[i] = regexBasedDictTest(regexHaystack, needles[i]);
            }
            })
        .on('start', function() {
            stdout(gWhich, '');
            stdout(gWhich, 'Test against large-size dictionary\n');
            })
        .on('cycle', function(event) {
            stdout(gWhich, String(event.target) + '\n');
            })
        .on('complete', nextBenchmark);
    return bms;
})());

window.onload = function() {
    document.getElementById('runBenchmark').onclick = function() {
        doBenchmark();
    };
};
</script>
</body>
</html>
